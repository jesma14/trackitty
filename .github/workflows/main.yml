name: "CI/CD"

on:
    pull_request:
        branches:
            - '**'
    push:
        branches:
            - '**'

jobs:
    build:
        name: Build & Release
        runs-on: ${{ matrix.os }}

        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        steps:
            #1 Checkout Repository
            - name: Checkout Repository
              uses: actions/checkout@v4

            #2 Setup Java
            - name: Set Up Java
              uses: actions/setup-java@v4
              with:
                distribution: 'oracle'
                java-version: '21'

            #3 Setup Flutter
            - name: Set Up Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: 3.24.1
            - run: flutter --version
          
            #4 Install Dependencies
            - name: Install Dependencies
              run: flutter pub get
              working-directory: ../trackitty/trackitty_app
            
            #5 Setup Keystore
            - name: Decode Keysgittore
              run: |
                echo "${{ secrets.KEYSTORE_BASE64 }} | base 64 --decode > android/app/trackitty_release_key.keystore"

            - name: Create key.properties
              run: |
                echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
                echo "keyPassword=${{ secrets.KEY_PASSWORD }} >> android/key.properties"
                echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
                echo "storeFile=keystore.jks" >> android/key.properties
              working-directory: ../trackitty/trackitty_app

            #6 Build App Bundle
            - name: Build App Bundle
              run: flutter build appbundle
              working-directory: ../trackitty/trackitty_app